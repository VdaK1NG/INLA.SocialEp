<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulation Study - Data Creation • INLA.SocialEp</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulation Study - Data Creation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">INLA.SocialEp</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Vignettes</h6></li>
    <li><a class="dropdown-item" href="../articles/simulation.html">Simulation Study - Data Creation</a></li>
    <li><a class="dropdown-item" href="../articles/example.html">example</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/VdaK1NG/INLA.SocialEp/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Simulation Study - Data Creation</h1>
                        <h4 data-toc-skip class="author">P.
Escobar-Hernandez, A. López-Quílez, F. Palmí-Perales</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/VdaK1NG/INLA.SocialEp/blob/main/vignettes/simulation.Rmd" class="external-link"><code>vignettes/simulation.Rmd</code></a></small>
      <div class="d-none name"><code>simulation.Rmd</code></div>
    </div>

    
    
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>
<style>
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    z-index: 2;
    color: #fff;
    background-color: #133BF2;
    border-color: #133BF2;
}
</style>
<div style="text-align: justify">





<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<div class="line-block">      For the simulation we are going to be
using US Counties that belong to the main continental part. After
downloading from official sources (<a href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html" class="external-link">US
Census Bureau</a>), we need to process the spatial object. Specifically,
we need to trim areas that are not connected to avoid possible problems
that may arise during the INLA approximation caused by a not-fully
connected graph underlying in the spatial effects. This means removing
Alaska and non-continental states, as well as two island counties (San
Juan and Nantucket), and leaving the final number of counties at
3104.</div>
<p><img src="simulation_files/figure-html/unnamed-chunk-4-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
<p>We are going to fix the seed for the random numbers using the number
of our <a href="https://arxiv.org/abs/2410.21227" class="external-link">ARXIV page</a> and use
and average of 100 observations per county, which would be 25 per group
if they were equally distributed.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set seed for the simulation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">241021227</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Total Number of Observations</span></span>
<span><span class="va">total_obs</span> <span class="op">&lt;-</span> <span class="va">n_county</span> <span class="op">*</span> <span class="fl">1000</span></span></code></pre></div>
<hr>
<div class="line-block">      We are going to assume that there are two
existing underlying <strong>risk factors</strong> that may affect
differently each of the risk groups. One of them presents a clear
north-south gradient, and will be simulated using mean temperatures over
the last 24 months. The second one presents a more diverse spatial
pattern, but is concentrated around highly populated areas and will be
generated using population density. Moreover, we are going to simulate
baseline independent spatial effects, as well as heterogeneity
effects.</div>
<div class="section level3">
<h3 id="baseline-risks">Baseline Risks<a class="anchor" aria-label="anchor" href="#baseline-risks"></a>
</h3>
<div class="line-block">      Finally, we are also going to consider two
different possibilities for each one of the previous conditions:</div>
<ul>
<li>
<strong>Different Risks</strong>: our dataset presents severe
differentes in the relative risk for each group. In order to make sure
that the model is able to detect this differences properly we will use a
dataset that presents pronounced differences between the groups.</li>
</ul>
<hr>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Different Risks</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_county</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_county</span>, <span class="fl">0.05</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_county</span>, <span class="op">-</span><span class="fl">0.3</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_county</span>, <span class="op">-</span><span class="fl">0.05</span>, <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-7-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
<ul>
<li>
<strong>Similar Risks</strong>: to complement the previous option we
will simulate two groups with a fairly similar relative risk.</li>
</ul>
<hr>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Similar Risks</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_county</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_county</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_county</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_county</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-9-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level3">
<h3 id="factor-1-temperature">Factor 1: Temperature<a class="anchor" aria-label="anchor" href="#factor-1-temperature"></a>
</h3>
<div class="line-block">      Mean temperature between the months of
January 2023 and January 2025 was extracted from official sources. Data
had around 100 missing values that were filled using the mean
temperature across all counties. In addition, values have been scaled to
oscillate between 0.5 and 1.5 so that they have a similar scale to the
rest of the values used. The final distribution of values is the
following:</div>
<hr>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load temp data</span></span>
<span><span class="va">temp_data</span> <span class="op">&lt;-</span> <span class="va">temp_data_us_23</span></span>
<span><span class="va">temp_data</span> <span class="op">&lt;-</span> <span class="va">temp_data</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">Name</span>, <span class="va">State</span>, <span class="va">Value</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>STATE_NAME<span class="op">=</span><span class="va">State</span>, NAMELSAD<span class="op">=</span><span class="va">Name</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">State</span>, <span class="op">-</span><span class="va">Name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge datasets</span></span>
<span><span class="va">us_counties</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">us_counties</span>, <span class="va">temp_data</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">Value</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Value</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Value</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Value</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        V1          </span></span>
<span><span class="co">##  Min.   :-2.41479  </span></span>
<span><span class="co">##  1st Qu.:-0.75341  </span></span>
<span><span class="co">##  Median :-0.09636  </span></span>
<span><span class="co">##  Mean   : 0.00000  </span></span>
<span><span class="co">##  3rd Qu.: 0.76249  </span></span>
<span><span class="co">##  Max.   : 3.41413</span></span></code></pre>
<p><img src="simulation_files/figure-html/unnamed-chunk-11-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level3">
<h3 id="factor-2-population-density">Factor 2: Population Density<a class="anchor" aria-label="anchor" href="#factor-2-population-density"></a>
</h3>
<div class="line-block">      Population estimates for 2023 were
obtained from official sources. To generate the population density
values we have used the area of land included in the shapefile
downloaded from the census.gov web. This values have been scaled as
well.</div>
<hr>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load population data</span></span>
<span><span class="va">cov_data</span> <span class="op">&lt;-</span> <span class="va">pop_data_us_23</span> </span>
<span><span class="va">cov_data</span> <span class="op">&lt;-</span> <span class="va">cov_data</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">STNAME</span>, <span class="va">CTYNAME</span>, <span class="va">POPESTIMATE2023</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>STATE_NAME<span class="op">=</span><span class="va">STNAME</span>, NAMELSAD<span class="op">=</span><span class="va">CTYNAME</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">STNAME</span>, <span class="op">-</span><span class="va">CTYNAME</span><span class="op">)</span></span>
<span><span class="va">cov_data</span> <span class="op">&lt;-</span> <span class="va">cov_data</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">cov_data</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Merge datasets</span></span>
<span><span class="va">us_counties</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">us_counties</span>, <span class="va">cov_data</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">POPESTIMATE2023</span><span class="op">[</span><span class="va">us_counties</span><span class="op">$</span><span class="va">NAMELSAD</span><span class="op">==</span><span class="st">"Doña Ana County"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">225210</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS</span> <span class="op">&lt;-</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">POPESTIMATE2023</span><span class="op">/</span><span class="va">us_counties</span><span class="op">$</span><span class="va">ALAND</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        V1           </span></span>
<span><span class="co">##  Min.   :-3.710532  </span></span>
<span><span class="co">##  1st Qu.:-0.558221  </span></span>
<span><span class="co">##  Median :-0.004318  </span></span>
<span><span class="co">##  Mean   : 0.000000  </span></span>
<span><span class="co">##  3rd Qu.: 0.554702  </span></span>
<span><span class="co">##  Max.   : 4.149420</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract Population variable for use later</span></span>
<span><span class="va">POP</span> <span class="op">&lt;-</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">POPESTIMATE2023</span></span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-13-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level3">
<h3 id="independent-spatial-effects">Independent Spatial Effects<a class="anchor" aria-label="anchor" href="#independent-spatial-effects"></a>
</h3>
<div class="line-block">      In this case we need to simulate 4
different spatial effects using the function <strong>rst()</strong> from
the package <strong>SUMMER</strong>.</div>
<hr>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_sp_ef</span> <span class="op">&lt;-</span> <span class="fu">rst</span><span class="op">(</span>n<span class="op">=</span><span class="fl">4</span>, type <span class="op">=</span> <span class="st">"s"</span>, type.s <span class="op">=</span> <span class="st">"ICAR"</span>, scale.model <span class="op">=</span> <span class="cn">FALSE</span>, Amat <span class="op">=</span> <span class="va">W</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ind.ef.g1</span> <span class="op">&lt;-</span> <span class="va">ind.ef</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="va">ind.ef.g2</span> <span class="op">&lt;-</span> <span class="va">ind.ef</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span></span>
<span><span class="va">ind.ef.g3</span> <span class="op">&lt;-</span> <span class="va">ind.ef</span><span class="op">[</span><span class="fl">3</span>, <span class="op">]</span></span>
<span><span class="va">ind.ef.g4</span> <span class="op">&lt;-</span> <span class="va">ind.ef</span><span class="op">[</span><span class="fl">4</span>, <span class="op">]</span></span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-16-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="no-spatial-effect">No Spatial Effect<a class="anchor" aria-label="anchor" href="#no-spatial-effect"></a>
</h2>
<div class="line-block">      In this case we are going to assign the
values using only population and the heterogeneity effect simulated for
each group.</div>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>1</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>ω</mi><mn>1</mn><mi>i</mi></msubsup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>2</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>ω</mi><mn>2</mn><mi>i</mi></msubsup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>3</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>ω</mi><mn>3</mn><mi>i</mi></msubsup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>4</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>ω</mi><mn>4</mn><mi>i</mi></msubsup></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
&amp; \theta_1^i=\omega_1^i \\
&amp; \theta_2^i=\omega_2^i \\
&amp; \theta_3^i=\omega_3^i \\
&amp; \theta_4^i=\omega_4^i
\end{aligned}
</annotation></semantics></math></p>
<div class="section level3">
<h3 id="groups-with-equal-risks">Groups with equal risks<a class="anchor" aria-label="anchor" href="#groups-with-equal-risks"></a>
</h3>
<hr>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate expected values depending on the population of the county (equal for all model used)</span></span>
<span><span class="va">total_pob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span><span class="op">)</span></span>
<span><span class="va">EXP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="va">POP</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pob</span><span class="op">*</span><span class="fl">4</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> </span>
<span>                       <span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_SIM_G1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_SIM_G2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_SIM_G3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_SIM_G4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk</span> <span class="op">&lt;-</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span></span>
<span><span class="va">g2_prk</span> <span class="op">&lt;-</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span></span>
<span><span class="va">g3_prk</span> <span class="op">&lt;-</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> </span>
<span><span class="va">g4_prk</span> <span class="op">&lt;-</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk</span><span class="op">)</span></span>
<span><span class="va">g2_prk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk</span><span class="op">)</span></span>
<span><span class="va">g3_prk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk</span><span class="op">)</span></span>
<span><span class="va">g4_prk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"M0_SIM"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk</span>, <span class="va">g2_prk</span>, <span class="va">g3_prk</span>, <span class="va">g4_prk</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_SIM_G1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_SIM_G2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_SIM_G3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_SIM_G4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M0_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"OBS_SIM"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"EXP"</span><span class="op">=</span><span class="va">EXP</span>, TYPE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G1"</span>, <span class="st">"G2"</span>, <span class="st">"G3"</span>, <span class="st">"G4"</span><span class="op">)</span>, each<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"idx"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_SIM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_SIM_G1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_SIM_G2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_SIM_G3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_SIM_G4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_SIM</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">total_dif</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M0_df</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_SIM</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_SIM</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M0_df</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_SIM</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_SIM</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_SIM</span><span class="op">)</span><span class="op">!=</span><span class="va">total_obs</span><span class="op">)</span><span class="op">{</span><span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Observed values and expected values do not match."</span><span class="op">)</span><span class="op">}</span></span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-18-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level3">
<h3 id="groups-with-different-risks">Groups with different risks<a class="anchor" aria-label="anchor" href="#groups-with-different-risks"></a>
</h3>
<hr>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> </span>
<span>                       <span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_DIF_G1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_DIF_G2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_DIF_G3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_DIF_G4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk</span> <span class="op">&lt;-</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span></span>
<span><span class="va">g2_prk</span> <span class="op">&lt;-</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span></span>
<span><span class="va">g3_prk</span> <span class="op">&lt;-</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> </span>
<span><span class="va">g4_prk</span> <span class="op">&lt;-</span> <span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk</span><span class="op">)</span></span>
<span><span class="va">g2_prk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk</span><span class="op">)</span></span>
<span><span class="va">g3_prk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk</span><span class="op">)</span></span>
<span><span class="va">g4_prk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M0_DIF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk</span>, <span class="va">g2_prk</span>, <span class="va">g3_prk</span>, <span class="va">g4_prk</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_DIF_G1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_DIF_G2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_DIF_G3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_DIF_G4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_DIF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_DIF_G1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_DIF_G2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_DIF_G3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M0_DIF_G4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_DIF</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">total_dif</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M0_df</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_DIF</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_DIF</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M0_df</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_DIF</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_DIF</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M0_df</span><span class="op">$</span><span class="va">OBS_DIF</span><span class="op">)</span><span class="op">!=</span><span class="va">total_obs</span><span class="op">)</span><span class="op">{</span><span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Observed values and expected values do not match."</span><span class="op">)</span><span class="op">}</span></span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-20-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="individual-spatial-effects">Individual Spatial Effects<a class="anchor" aria-label="anchor" href="#individual-spatial-effects"></a>
</h2>
<div class="line-block">      In this case we need to simulate 4
different spatial effects using the function <strong>rst()</strong> from
the package <strong>SUMMER</strong>. Each spatial effect will be
combined with the underlying risk assigned to each county and each
group, and used to distribute the number of observed cases. We will
rescale the spatial effects to be between -1 and 1 so that the assigned
risk groups dont go to far below .</div>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>1</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>1</mn></msubsup><msubsup><mi>ω</mi><mn>1</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>1</mn></msubsup><msub><mi>ϕ</mi><mn>1</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>2</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>2</mn></msubsup><msubsup><mi>ω</mi><mn>2</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>2</mn></msubsup><msub><mi>ϕ</mi><mn>2</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>3</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>3</mn></msubsup><msubsup><mi>ω</mi><mn>3</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>3</mn></msubsup><msub><mi>ϕ</mi><mn>3</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>4</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>4</mn></msubsup><msubsup><mi>ω</mi><mn>4</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>4</mn></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
&amp; \theta_1^i=\gamma_1^1 \omega_1^i + \gamma_2^1 \phi_1 \\
&amp; \theta_2^i=\gamma_1^2 \omega_2^i + \gamma_2^2 \phi_2 \\
&amp; \theta_3^i=\gamma_1^3 \omega_3^i + \gamma_2^3 \phi_3 \\
&amp; \theta_4^i=\gamma_1^4 \omega_4^i + \gamma_2^4 \phi_4
\end{aligned}
</annotation></semantics></math></p>
<div class="section level3">
<h3 class="tabset" id="groups-with-equal-risks-1">Groups with equal risks<a class="anchor" aria-label="anchor" href="#groups-with-equal-risks-1"></a>
</h3>
<hr>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g1</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g3</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g4</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g1</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g3</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g4</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g1</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g3</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g4</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M1_SIM_V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v1</span>, <span class="va">g2_prk_v1</span>, <span class="va">g3_prk_v1</span>, <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M1_SIM_V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v2</span>, <span class="va">g2_prk_v2</span>, <span class="va">g3_prk_v2</span>, <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M1_SIM_V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v3</span>, <span class="va">g2_prk_v3</span>, <span class="va">g3_prk_v3</span>, <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G1_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G2_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G3_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G4_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G1_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G2_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G3_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G4_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G1_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G2_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G3_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G4_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M1_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"OBS_SIM_v1"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v1"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_SIM_v2"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v2"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_SIM_v3"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v3"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"EXP"</span><span class="op">=</span><span class="va">EXP</span>, </span>
<span>                    TYPE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G1"</span>, <span class="st">"G2"</span>, <span class="st">"G3"</span>, <span class="st">"G4"</span><span class="op">)</span>, each<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"idx"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G1_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G2_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G3_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G4_v1</span><span class="op">)</span></span>
<span><span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G1_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G2_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G3_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G4_v2</span><span class="op">)</span></span>
<span><span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G1_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G2_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G3_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_SIM_G4_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">)</span></span>
<span><span class="va">total_dif_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">)</span></span>
<span><span class="va">total_dif_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">total_dif_v1</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">)</span>, <span class="va">total_dif_v2</span><span class="op">)</span></span>
<span>  <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">total_dif_v3</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="v1---equal-weights">V1 - Equal Weights<a class="anchor" aria-label="anchor" href="#v1---equal-weights"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-22-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v2---heterogeneity-max-risk">V2 - Heterogeneity Max Risk<a class="anchor" aria-label="anchor" href="#v2---heterogeneity-max-risk"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-23-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v3---last-effect-max-risk">V3 - Last Effect Max Risk<a class="anchor" aria-label="anchor" href="#v3---last-effect-max-risk"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-24-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
<div class="section level3">
<h3 class="tabset" id="groups-with-different-risks-1">Groups with different risks<a class="anchor" aria-label="anchor" href="#groups-with-different-risks-1"></a>
</h3>
<div class="line-block">      Just like in the previous section, we
generate the same underlying risks by adding the underlying simulated
risk for each county and group to each different spatial effect. The
following figure represents the final rates after dividing the number of
cases among the counties using the total risk assigned.</div>
<hr>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g1</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g3</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g4</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g1</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g3</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g4</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g1</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g3</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g4</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M1_DIF_V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v1</span>, <span class="va">g2_prk_v1</span>, <span class="va">g3_prk_v1</span>, <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M1_DIF_V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v2</span>, <span class="va">g2_prk_v2</span>, <span class="va">g3_prk_v2</span>, <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M1_DIF_V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v3</span>, <span class="va">g2_prk_v3</span>, <span class="va">g3_prk_v3</span>, <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G1_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G2_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G3_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G4_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G1_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G2_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G3_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G4_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G1_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G2_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G3_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G4_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G1_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G2_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G3_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G4_v1</span><span class="op">)</span></span>
<span><span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G1_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G2_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G3_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G4_v2</span><span class="op">)</span></span>
<span><span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G1_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G2_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G3_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M1_DIF_G4_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">)</span></span>
<span><span class="va">total_dif_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">)</span></span>
<span><span class="va">total_dif_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M1_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M1_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="v1---equal-weights-1">V1 - Equal Weights<a class="anchor" aria-label="anchor" href="#v1---equal-weights-1"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-26-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v2---heterogeneity-max-risk-1">V2 - Heterogeneity Max Risk<a class="anchor" aria-label="anchor" href="#v2---heterogeneity-max-risk-1"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-27-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v3---last-effect-max-risk-1">V3 - Last Effect Max Risk<a class="anchor" aria-label="anchor" href="#v3---last-effect-max-risk-1"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-28-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="shared-spatial-effect">Shared Spatial Effect<a class="anchor" aria-label="anchor" href="#shared-spatial-effect"></a>
</h2>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>1</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>1</mn></msubsup><msubsup><mi>ω</mi><mn>1</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>1</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>2</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>2</mn></msubsup><msubsup><mi>ω</mi><mn>2</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>2</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>3</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>3</mn></msubsup><msubsup><mi>ω</mi><mn>3</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>3</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>4</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>4</mn></msubsup><msubsup><mi>ω</mi><mn>4</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
&amp; \theta_1^i=\gamma_1^1 \omega_1^i + \gamma_2^1 \phi_{11} \\
&amp; \theta_2^i=\gamma_1^2 \omega_2^i + \gamma_2^2 \phi_{11} \\
&amp; \theta_3^i=\gamma_1^3 \omega_3^i + \gamma_2^3 \phi_{11} \\
&amp; \theta_4^i=\gamma_1^4 \omega_4^i + \gamma_2^4 \phi_{11}
\end{aligned}
</annotation></semantics></math></p>
<div class="section level3">
<h3 class="tabset" id="groups-with-equal-risks-2">Groups with equal risks<a class="anchor" aria-label="anchor" href="#groups-with-equal-risks-2"></a>
</h3>
<hr>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M2_SIM_V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v1</span>, <span class="va">g2_prk_v1</span>, <span class="va">g3_prk_v1</span>, <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M2_SIM_V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v2</span>, <span class="va">g2_prk_v2</span>, <span class="va">g3_prk_v2</span>, <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M2_SIM_V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v3</span>, <span class="va">g2_prk_v3</span>, <span class="va">g3_prk_v3</span>, <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G1_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G2_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G3_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G4_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G1_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G2_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G3_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G4_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G1_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G2_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G3_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G4_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M2_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"OBS_SIM_v1"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v1"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_SIM_v2"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v2"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_SIM_v3"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v3"</span><span class="op">=</span><span class="cn">NA</span>,<span class="st">"EXP"</span><span class="op">=</span><span class="va">EXP</span>, </span>
<span>                    TYPE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G1"</span>, <span class="st">"G2"</span>, <span class="st">"G3"</span>, <span class="st">"G4"</span><span class="op">)</span>, each<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"idx"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G1_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G2_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G3_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G4_v1</span><span class="op">)</span></span>
<span><span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G1_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G2_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G3_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G4_v2</span><span class="op">)</span></span>
<span><span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G1_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G2_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G3_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_SIM_G4_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">)</span></span>
<span><span class="va">total_dif_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">)</span></span>
<span><span class="va">total_dif_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="v1---equal-weights-2">V1 - Equal Weights<a class="anchor" aria-label="anchor" href="#v1---equal-weights-2"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-30-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v2---heterogeneity-max-risk-2">V2 - Heterogeneity Max Risk<a class="anchor" aria-label="anchor" href="#v2---heterogeneity-max-risk-2"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-31-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v3---last-effect-max-risk-2">V3 - Last Effect Max Risk<a class="anchor" aria-label="anchor" href="#v3---last-effect-max-risk-2"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-32-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
<div class="section level3">
<h3 class="tabset" id="groups-with-different-risks-2">Groups with different risks<a class="anchor" aria-label="anchor" href="#groups-with-different-risks-2"></a>
</h3>
<div class="line-block">      Just like in the previous section, we
generate the same underlying risks by adding the underlying simulated
risk for each county and group to each different spatial effect. The
following figure represents the final rates after dividing the number of
cases among the counties using the total risk assigned.</div>
<hr>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M2_DIF_V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v1</span>, <span class="va">g2_prk_v1</span>, <span class="va">g3_prk_v1</span>, <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M2_DIF_V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v2</span>, <span class="va">g2_prk_v2</span>, <span class="va">g3_prk_v2</span>, <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M2_DIF_V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v3</span>, <span class="va">g2_prk_v3</span>, <span class="va">g3_prk_v3</span>, <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G1_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G2_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G3_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G4_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G1_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G2_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G3_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G4_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G1_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G2_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G3_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G4_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G1_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G2_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G3_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G4_v1</span><span class="op">)</span></span>
<span><span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G1_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G2_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G3_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G4_v2</span><span class="op">)</span></span>
<span><span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G1_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G2_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G3_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M2_DIF_G4_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">)</span></span>
<span><span class="va">total_dif_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">)</span></span>
<span><span class="va">total_dif_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M2_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="v1---equal-weights-3">V1 - Equal Weights<a class="anchor" aria-label="anchor" href="#v1---equal-weights-3"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-34-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v2---heterogeneity-max-risk-3">V2 - Heterogeneity Max Risk<a class="anchor" aria-label="anchor" href="#v2---heterogeneity-max-risk-3"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-35-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v3---last-effect-max-risk-3">V3 - Last Effect Max Risk<a class="anchor" aria-label="anchor" href="#v3---last-effect-max-risk-3"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-36-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="factor-2-spatial-effect-rural-urban">Factor 2 Spatial Effect (Rural-Urban)<a class="anchor" aria-label="anchor" href="#factor-2-spatial-effect-rural-urban"></a>
</h2>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>1</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>1</mn></msubsup><msubsup><mi>ω</mi><mn>1</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>1</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>2</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>2</mn></msubsup><msubsup><mi>ω</mi><mn>2</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>2</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>3</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>3</mn></msubsup><msubsup><mi>ω</mi><mn>3</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>3</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>3</mn><mn>3</mn></msubsup><msub><mi>ϕ</mi><mn>21</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>4</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>4</mn></msubsup><msubsup><mi>ω</mi><mn>4</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>3</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>21</mn></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
&amp; \theta_1^i=\gamma_1^1 \omega_1^i + \gamma_2^1 \phi_{11} \\
&amp; \theta_2^i=\gamma_1^2 \omega_2^i + \gamma_2^2 \phi_{11} \\
&amp; \theta_3^i=\gamma_1^3 \omega_3^i + \gamma_2^3 \phi_{11} + \gamma_3^3 \phi_{21} \\
&amp; \theta_4^i=\gamma_1^4 \omega_4^i + \gamma_2^4 \phi_{11} + \gamma_3^4 \phi_{21}
\end{aligned}
</annotation></semantics></math></p>
<div class="section level3">
<h3 class="tabset" id="groups-with-equal-risks-3">Groups with equal risks<a class="anchor" aria-label="anchor" href="#groups-with-equal-risks-3"></a>
</h3>
<hr>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span> </span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> </span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> </span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M3_SIM_V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v1</span>, <span class="va">g2_prk_v1</span>, <span class="va">g3_prk_v1</span>, <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M3_SIM_V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v2</span>, <span class="va">g2_prk_v2</span>, <span class="va">g3_prk_v2</span>, <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M3_SIM_V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v3</span>, <span class="va">g2_prk_v3</span>, <span class="va">g3_prk_v3</span>, <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G1_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G2_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G3_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G4_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G1_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G2_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G3_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G4_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G1_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G2_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G3_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G4_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M3_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"OBS_SIM_v1"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v1"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_SIM_v2"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v2"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_SIM_v3"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v3"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"EXP"</span><span class="op">=</span><span class="va">EXP</span>, </span>
<span>                    TYPE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G1"</span>, <span class="st">"G2"</span>, <span class="st">"G3"</span>, <span class="st">"G4"</span><span class="op">)</span>, each<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"idx"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G1_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G2_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G3_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G4_v1</span><span class="op">)</span></span>
<span><span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G1_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G2_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G3_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G4_v2</span><span class="op">)</span></span>
<span><span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G1_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G2_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G3_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_SIM_G4_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">)</span></span>
<span><span class="va">total_dif_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">)</span></span>
<span><span class="va">total_dif_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M3_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M3_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M3_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M3_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M3_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M3_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="v1---equal-weights-4">V1 - Equal Weights<a class="anchor" aria-label="anchor" href="#v1---equal-weights-4"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-38-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v2---heterogeneity-max-risk-4">V2 - Heterogeneity Max Risk<a class="anchor" aria-label="anchor" href="#v2---heterogeneity-max-risk-4"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-39-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v3---last-effect-max-risk-4">V3 - Last Effect Max Risk<a class="anchor" aria-label="anchor" href="#v3---last-effect-max-risk-4"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-40-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
<div class="section level3">
<h3 class="tabset" id="groups-with-different-risks-3">Groups with different risks<a class="anchor" aria-label="anchor" href="#groups-with-different-risks-3"></a>
</h3>
<div class="line-block">      Just like in the previous section, we
generate the same underlying risks by adding the underlying simulated
risk for each county and group to each different spatial effect. The
following figure represents the final rates after dividing the number of
cases among the counties using the total risk assigned.</div>
<hr>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span> </span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> </span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> </span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M3_DIF_V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v1</span>, <span class="va">g2_prk_v1</span>, <span class="va">g3_prk_v1</span>, <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M3_DIF_V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v2</span>, <span class="va">g2_prk_v2</span>, <span class="va">g3_prk_v2</span>, <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M3_DIF_V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v3</span>, <span class="va">g2_prk_v3</span>, <span class="va">g3_prk_v3</span>, <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G1_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G2_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G3_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G4_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G1_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G2_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G3_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G4_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G1_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G2_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G3_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G4_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G1_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G2_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G3_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G4_v1</span><span class="op">)</span></span>
<span><span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G1_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G2_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G3_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G4_v2</span><span class="op">)</span></span>
<span><span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G1_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G2_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G3_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M3_DIF_G4_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">)</span></span>
<span><span class="va">total_dif_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">)</span></span>
<span><span class="va">total_dif_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M3_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="v1---equal-weights-5">V1 - Equal Weights<a class="anchor" aria-label="anchor" href="#v1---equal-weights-5"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-42-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v2---heterogeneity-max-risk-5">V2 - Heterogeneity Max Risk<a class="anchor" aria-label="anchor" href="#v2---heterogeneity-max-risk-5"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-43-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v3---last-effect-max-risk-5">V3 - Last Effect Max Risk<a class="anchor" aria-label="anchor" href="#v3---last-effect-max-risk-5"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-44-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="factor-2-spatial-effect-north-south">Factor 2 Spatial Effect (North-South)<a class="anchor" aria-label="anchor" href="#factor-2-spatial-effect-north-south"></a>
</h2>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>1</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>1</mn></msubsup><msubsup><mi>ω</mi><mn>1</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>1</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>2</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>2</mn></msubsup><msubsup><mi>ω</mi><mn>2</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>2</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>3</mn><mn>2</mn></msubsup><msub><mi>ϕ</mi><mn>12</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>3</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>3</mn></msubsup><msubsup><mi>ω</mi><mn>3</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>3</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>4</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>4</mn></msubsup><msubsup><mi>ω</mi><mn>4</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>3</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>12</mn></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
&amp; \theta_1^i=\gamma_1^1 \omega_1^i + \gamma_2^1 \phi_{11} \\
&amp; \theta_2^i=\gamma_1^2 \omega_2^i + \gamma_2^2 \phi_{11} + \gamma_3^2 \phi_{12} \\
&amp; \theta_3^i=\gamma_1^3 \omega_3^i + \gamma_2^3 \phi_{11} \\
&amp; \theta_4^i=\gamma_1^4 \omega_4^i + \gamma_2^4 \phi_{11} + \gamma_3^4 \phi_{12} 
\end{aligned}
</annotation></semantics></math></p>
<div class="section level3">
<h3 class="tabset" id="groups-with-equal-risks-4">Groups with equal risks<a class="anchor" aria-label="anchor" href="#groups-with-equal-risks-4"></a>
</h3>
<hr>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M4_SIM_V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v1</span>, <span class="va">g2_prk_v1</span>, <span class="va">g3_prk_v1</span>, <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M4_SIM_V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v2</span>, <span class="va">g2_prk_v2</span>, <span class="va">g3_prk_v2</span>, <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M4_SIM_V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v3</span>, <span class="va">g2_prk_v3</span>, <span class="va">g3_prk_v3</span>, <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G1_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G2_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G3_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G4_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G1_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G2_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G3_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G4_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G1_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G2_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G3_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G4_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M4_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"OBS_SIM_v1"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v1"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_SIM_v2"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v2"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_SIM_v3"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v3"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"EXP"</span><span class="op">=</span><span class="va">EXP</span>, </span>
<span>                    TYPE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G1"</span>, <span class="st">"G2"</span>, <span class="st">"G3"</span>, <span class="st">"G4"</span><span class="op">)</span>, each<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"idx"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G1_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G2_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G3_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G4_v1</span><span class="op">)</span></span>
<span><span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G1_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G2_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G3_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G4_v2</span><span class="op">)</span></span>
<span><span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G1_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G2_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G3_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_SIM_G4_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">)</span></span>
<span><span class="va">total_dif_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">)</span></span>
<span><span class="va">total_dif_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="v1---equal-weights-6">V1 - Equal Weights<a class="anchor" aria-label="anchor" href="#v1---equal-weights-6"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-46-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v2---heterogeneity-max-risk-6">V2 - Heterogeneity Max Risk<a class="anchor" aria-label="anchor" href="#v2---heterogeneity-max-risk-6"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-47-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v3---last-effect-max-risk-6">V3 - Last Effect Max Risk<a class="anchor" aria-label="anchor" href="#v3---last-effect-max-risk-6"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-48-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
<div class="section level3">
<h3 class="tabset" id="groups-with-different-risks-4">Groups with different risks<a class="anchor" aria-label="anchor" href="#groups-with-different-risks-4"></a>
</h3>
<div class="line-block">      Just like in the previous section, we
generate the same underlying risks by adding the underlying simulated
risk for each county and group to each different spatial effect. The
following figure represents the final rates after dividing the number of
cases among the counties using the total risk assigned.</div>
<hr>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M4_DIF_V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v1</span>, <span class="va">g2_prk_v1</span>, <span class="va">g3_prk_v1</span>, <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M4_DIF_V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v2</span>, <span class="va">g2_prk_v2</span>, <span class="va">g3_prk_v2</span>, <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M4_DIF_V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v3</span>, <span class="va">g2_prk_v3</span>, <span class="va">g3_prk_v3</span>, <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G1_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G2_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G3_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G4_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G1_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G2_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G3_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G4_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G1_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G2_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G3_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G4_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G1_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G2_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G3_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G4_v1</span><span class="op">)</span></span>
<span><span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G1_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G2_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G3_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G4_v2</span><span class="op">)</span></span>
<span><span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G1_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G2_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G3_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M4_DIF_G4_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">)</span></span>
<span><span class="va">total_dif_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">)</span></span>
<span><span class="va">total_dif_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M4_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M4_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="v1---equal-weights-7">V1 - Equal Weights<a class="anchor" aria-label="anchor" href="#v1---equal-weights-7"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-50-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v2---heterogeneity-max-risk-7">V2 - Heterogeneity Max Risk<a class="anchor" aria-label="anchor" href="#v2---heterogeneity-max-risk-7"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-51-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v3---last-effect-max-risk-7">V3 - Last Effect Max Risk<a class="anchor" aria-label="anchor" href="#v3---last-effect-max-risk-7"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-52-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="factor-1-factor-2">Factor 1 + Factor 2<a class="anchor" aria-label="anchor" href="#factor-1-factor-2"></a>
</h2>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>1</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>1</mn></msubsup><msubsup><mi>ω</mi><mn>1</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>1</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>2</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>2</mn></msubsup><msubsup><mi>ω</mi><mn>2</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>2</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>3</mn><mn>2</mn></msubsup><msub><mi>ϕ</mi><mn>12</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>3</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>3</mn></msubsup><msubsup><mi>ω</mi><mn>3</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>3</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>3</mn><mn>3</mn></msubsup><msub><mi>ϕ</mi><mn>21</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>4</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>4</mn></msubsup><msubsup><mi>ω</mi><mn>4</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>3</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>12</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>4</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>21</mn></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
&amp; \theta_1^i=\gamma_1^1 \omega_1^i + \gamma_2^1 \phi_{11} \\
&amp; \theta_2^i=\gamma_1^2 \omega_2^i + \gamma_2^2 \phi_{11} + \gamma_3^2 \phi_{12} \\
&amp; \theta_3^i=\gamma_1^3 \omega_3^i + \gamma_2^3 \phi_{11} + \gamma_3^3 \phi_{21} \\
&amp; \theta_4^i=\gamma_1^4 \omega_4^i + \gamma_2^4 \phi_{11} + \gamma_3^4 \phi_{12} + \gamma_4^4 \phi_{21}
\end{aligned}
</annotation></semantics></math></p>
<div class="section level3">
<h3 class="tabset" id="groups-with-equal-risks-5">Groups with equal risks<a class="anchor" aria-label="anchor" href="#groups-with-equal-risks-5"></a>
</h3>
<hr>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">53</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">26</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">13</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span> <span class="op">+</span> <span class="fl">8</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">8</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">53</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">26</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span> <span class="op">+</span> <span class="fl">13</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M5_SIM_V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v1</span>, <span class="va">g2_prk_v1</span>, <span class="va">g3_prk_v1</span>, <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M5_SIM_V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v2</span>, <span class="va">g2_prk_v2</span>, <span class="va">g3_prk_v2</span>, <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M5_SIM_V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v3</span>, <span class="va">g2_prk_v3</span>, <span class="va">g3_prk_v3</span>, <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G1_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G2_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G3_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G4_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G1_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G2_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G3_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G4_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G1_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G2_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G3_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G4_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M5_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"OBS_SIM_v1"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v1"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_SIM_v2"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v2"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_SIM_v3"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v3"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"EXP"</span><span class="op">=</span><span class="va">EXP</span>, </span>
<span>                    TYPE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G1"</span>, <span class="st">"G2"</span>, <span class="st">"G3"</span>, <span class="st">"G4"</span><span class="op">)</span>, each<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"idx"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G1_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G2_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G3_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G4_v1</span><span class="op">)</span></span>
<span><span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G1_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G2_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G3_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G4_v2</span><span class="op">)</span></span>
<span><span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G1_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G2_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G3_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_SIM_G4_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">)</span></span>
<span><span class="va">total_dif_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">)</span></span>
<span><span class="va">total_dif_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="v1---equal-weights-8">V1 - Equal Weights<a class="anchor" aria-label="anchor" href="#v1---equal-weights-8"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-54-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v2---heterogeneity-max-risk-8">V2 - Heterogeneity Max Risk<a class="anchor" aria-label="anchor" href="#v2---heterogeneity-max-risk-8"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-55-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v3---last-effect-max-risk-8">V3 - Last Effect Max Risk<a class="anchor" aria-label="anchor" href="#v3---last-effect-max-risk-8"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-56-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
<div class="section level3">
<h3 class="tabset" id="groups-with-different-risks-5">Groups with different risks<a class="anchor" aria-label="anchor" href="#groups-with-different-risks-5"></a>
</h3>
<div class="line-block">      Just like in the previous section, we
generate the same underlying risks by adding the underlying simulated
risk for each county and group to each different spatial effect. The
following figure represents the final rates after dividing the number of
cases among the counties using the total risk assigned.</div>
<hr>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">53</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">26</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">13</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span> <span class="op">+</span> <span class="fl">8</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">8</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">53</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">26</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span> <span class="op">+</span> <span class="fl">13</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M5_DIF_V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v1</span>, <span class="va">g2_prk_v1</span>, <span class="va">g3_prk_v1</span>, <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M5_DIF_V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v2</span>, <span class="va">g2_prk_v2</span>, <span class="va">g3_prk_v2</span>, <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M5_DIF_V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v3</span>, <span class="va">g2_prk_v3</span>, <span class="va">g3_prk_v3</span>, <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G1_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G2_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G3_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G4_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G1_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G2_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G3_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G4_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G1_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G2_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G3_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G4_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G1_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G2_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G3_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G4_v1</span><span class="op">)</span></span>
<span><span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G1_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G2_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G3_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G4_v2</span><span class="op">)</span></span>
<span><span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G1_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G2_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G3_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M5_DIF_G4_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">)</span></span>
<span><span class="va">total_dif_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">)</span></span>
<span><span class="va">total_dif_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M5_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="v1---equal-weights-9">V1 - Equal Weights<a class="anchor" aria-label="anchor" href="#v1---equal-weights-9"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-58-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v2---heterogeneity-max-risk-9">V2 - Heterogeneity Max Risk<a class="anchor" aria-label="anchor" href="#v2---heterogeneity-max-risk-9"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-59-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v3---last-effect-max-risk-9">V3 - Last Effect Max Risk<a class="anchor" aria-label="anchor" href="#v3---last-effect-max-risk-9"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-60-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="factor-1-factor-2-1">Factor 1 * Factor 2<a class="anchor" aria-label="anchor" href="#factor-1-factor-2-1"></a>
</h2>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>1</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>1</mn></msubsup><msubsup><mi>ω</mi><mn>1</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>1</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>2</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>2</mn></msubsup><msubsup><mi>ω</mi><mn>2</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>2</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>3</mn><mn>2</mn></msubsup><msub><mi>ϕ</mi><mn>12</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>3</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>3</mn></msubsup><msubsup><mi>ω</mi><mn>3</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>3</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>3</mn><mn>3</mn></msubsup><msub><mi>ϕ</mi><mn>21</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>4</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>21</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><msubsup><mi>θ</mi><mn>4</mn><mi>i</mi></msubsup><mo>=</mo><msubsup><mi>γ</mi><mn>1</mn><mn>4</mn></msubsup><msubsup><mi>ω</mi><mn>4</mn><mi>i</mi></msubsup><mo>+</mo><msubsup><mi>γ</mi><mn>2</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>11</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>3</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>12</mn></msub><mo>+</mo><msubsup><mi>γ</mi><mn>4</mn><mn>4</mn></msubsup><msub><mi>ϕ</mi><mn>22</mn></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
&amp; \theta_1^i=\gamma_1^1 \omega_1^i + \gamma_2^1 \phi_{11} \\
&amp; \theta_2^i=\gamma_1^2 \omega_2^i + \gamma_2^2 \phi_{11} + \gamma_3^2 \phi_{12} \\
&amp; \theta_3^i=\gamma_1^3 \omega_3^i + \gamma_2^3 \phi_{11} + \gamma_3^3 \phi_{21} + \gamma_4^4 \phi_{21}\\
&amp; \theta_4^i=\gamma_1^4 \omega_4^i + \gamma_2^4 \phi_{11} + \gamma_3^4 \phi_{12} + \gamma_4^4 \phi_{22}
\end{aligned}
</annotation></semantics></math></p>
<div class="section level3">
<h3 class="tabset" id="groups-with-equal-risks-6">Groups with equal risks<a class="anchor" aria-label="anchor" href="#groups-with-equal-risks-6"></a>
</h3>
<hr>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">ind.ef.g1</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">53</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">26</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">13</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">ind.ef.g1</span> <span class="op">+</span> <span class="fl">8</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_sim_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">8</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_sim_risk</span> <span class="op">+</span> <span class="fl">53</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">26</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">ind.ef.g1</span> <span class="op">+</span> <span class="fl">13</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_sim_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M6_SIM_V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v1</span>, <span class="va">g2_prk_v1</span>, <span class="va">g3_prk_v1</span>, <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M6_SIM_V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v2</span>, <span class="va">g2_prk_v2</span>, <span class="va">g3_prk_v2</span>, <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M6_SIM_V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v3</span>, <span class="va">g2_prk_v3</span>, <span class="va">g3_prk_v3</span>, <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G1_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G2_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G3_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G4_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G1_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G2_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G3_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G4_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G1_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G2_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G3_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G4_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M6_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"OBS_SIM_v1"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v1"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_SIM_v2"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v2"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_SIM_v3"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"OBS_DIF_v3"</span><span class="op">=</span><span class="cn">NA</span>, <span class="st">"EXP"</span><span class="op">=</span><span class="va">EXP</span>, </span>
<span>                    TYPE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G1"</span>, <span class="st">"G2"</span>, <span class="st">"G3"</span>, <span class="st">"G4"</span><span class="op">)</span>, each<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"idx"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G1_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G2_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G3_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G4_v1</span><span class="op">)</span></span>
<span><span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G1_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G2_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G3_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G4_v2</span><span class="op">)</span></span>
<span><span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G1_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G2_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G3_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_SIM_G4_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">)</span></span>
<span><span class="va">total_dif_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">)</span></span>
<span><span class="va">total_dif_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_SIM_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="v1---equal-weights-10">V1 - Equal Weights<a class="anchor" aria-label="anchor" href="#v1---equal-weights-10"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-62-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v2---heterogeneity-max-risk-10">V2 - Heterogeneity Max Risk<a class="anchor" aria-label="anchor" href="#v2---heterogeneity-max-risk-10"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-63-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v3---last-effect-max-risk-10">V3 - Last Effect Max Risk<a class="anchor" aria-label="anchor" href="#v3---last-effect-max-risk-10"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-64-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
<div class="section level3">
<h3 class="tabset" id="groups-with-different-risks-6">Groups with different risks<a class="anchor" aria-label="anchor" href="#groups-with-different-risks-6"></a>
</h3>
<div class="line-block">      Just like in the previous section, we
generate the same underlying risks by adding the underlying simulated
risk for each county and group to each different spatial effect. The
following figure represents the final rates after dividing the number of
cases among the counties using the total risk assigned.</div>
<hr>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate underlying risk for each group</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">ind.ef.g1</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">53</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">26</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">13</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">ind.ef.g1</span> <span class="op">+</span> <span class="fl">8</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group1_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group2_dif_risk</span> <span class="op">+</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">*</span><span class="va">ind.ef.g2</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">8</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group3_dif_risk</span> <span class="op">+</span> <span class="fl">53</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">26</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">ind.ef.g1</span> <span class="op">+</span> <span class="fl">13</span><span class="op">/</span><span class="fl">100</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">Temp_Scale</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">group4_dif_risk</span> <span class="op">+</span> <span class="fl">7</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">ind.ef.g2</span> <span class="op">+</span> <span class="fl">14</span><span class="op">/</span><span class="fl">25</span><span class="op">*</span><span class="va">us_counties</span><span class="op">$</span><span class="va">POP_DENS_Scale</span></span>
<span></span>
<span><span class="co"># Exponential of the underlying risk to match log of the linear predictor</span></span>
<span><span class="va">g1_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v1</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v2</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g1_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g2_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g2_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g3_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g3_prk_v3</span><span class="op">)</span></span>
<span><span class="va">g4_prk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M6_DIF_V1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v1</span>, <span class="va">g2_prk_v1</span>, <span class="va">g3_prk_v1</span>, <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M6_DIF_V2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v2</span>, <span class="va">g2_prk_v2</span>, <span class="va">g3_prk_v2</span>, <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">data_risk</span><span class="op">$</span><span class="va">M6_DIF_V3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_prk_v3</span>, <span class="va">g2_prk_v3</span>, <span class="va">g3_prk_v3</span>, <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the total combination of population and risks</span></span>
<span><span class="va">total_pobrisk_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span></span>
<span><span class="va">total_pobrisk_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span> <span class="op">+</span> <span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observed values to sp object for ploting</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G1_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G2_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G3_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G4_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G1_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G2_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G3_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G4_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v2</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G1_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g1_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G2_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g2_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G3_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g3_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G4_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_obs</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">POP</span> <span class="op">*</span> <span class="va">g4_prk_v3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">total_pobrisk_v3</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataframe for M0 models and estimate observed values depending on risks</span></span>
<span><span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G1_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G2_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G3_v1</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G4_v1</span><span class="op">)</span></span>
<span><span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G1_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G2_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G3_v2</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G4_v2</span><span class="op">)</span></span>
<span><span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G1_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G2_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G3_v3</span>, <span class="va">us_counties</span><span class="op">$</span><span class="va">OBS_M6_DIF_G4_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compensate the different numbers of observed and expected cases caused by decimals</span></span>
<span><span class="va">total_dif_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">)</span></span>
<span><span class="va">total_dif_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">)</span></span>
<span><span class="va">total_dif_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXP</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v1</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v2</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M2_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">total_dif_v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M6_df</span><span class="op">$</span><span class="va">OBS_DIF_v3</span><span class="op">[</span><span class="va">r_ids</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="v1---equal-weights-11">V1 - Equal Weights<a class="anchor" aria-label="anchor" href="#v1---equal-weights-11"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-66-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v2---heterogeneity-max-risk-11">V2 - Heterogeneity Max Risk<a class="anchor" aria-label="anchor" href="#v2---heterogeneity-max-risk-11"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-67-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
<div class="section level4">
<h4 id="v3---last-effect-max-risk-11">V3 - Last Effect Max Risk<a class="anchor" aria-label="anchor" href="#v3---last-effect-max-risk-11"></a>
</h4>
<p><img src="simulation_files/figure-html/unnamed-chunk-68-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="save-data">Save Data<a class="anchor" aria-label="anchor" href="#save-data"></a>
</h2>
<div class="line-block">      Lastly, we save all the necessary objects
that we will be using in the analysis part and the results part.</div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">M0_df</span>, <span class="va">M1_df</span>, <span class="va">M2_df</span>, <span class="va">M3_df</span>, <span class="va">M4_df</span>, <span class="va">M5_df</span>, <span class="va">M6_df</span>, <span class="va">W</span>, <span class="va">graph</span>, <span class="va">us_counties</span>, file<span class="op">=</span><span class="st">"./Datos/sim_data.Rdata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sp_object</span> <span class="op">&lt;-</span> <span class="va">us_counties</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">geometry</span>, <span class="va">NAME</span>, <span class="va">NAMELSAD</span>, </span>
<span>                                    <span class="va">group1_dif_risk</span>, <span class="va">group2_dif_risk</span>, <span class="va">group3_dif_risk</span>, <span class="va">group4_dif_risk</span>, <span class="va">group1_sim_risk</span>, <span class="va">group2_sim_risk</span>, <span class="va">group3_sim_risk</span>, <span class="va">group4_sim_risk</span>, </span>
<span>                                    <span class="va">Temp_Scale</span>, <span class="va">POP_DENS_Scale</span><span class="op">)</span></span>
<span><span class="va">sp_object</span><span class="op">$</span><span class="va">ind.ef.g2</span> <span class="op">&lt;-</span> <span class="va">ind.ef.g2</span></span>
<span><span class="va">sp_object</span><span class="op">$</span><span class="va">ind.ef.g1</span> <span class="op">&lt;-</span> <span class="va">ind.ef.g1</span></span>
<span><span class="va">sp_object</span><span class="op">$</span><span class="va">ind.ef.g3</span> <span class="op">&lt;-</span> <span class="va">ind.ef.g3</span></span>
<span><span class="va">sp_object</span><span class="op">$</span><span class="va">ind.ef.g4</span> <span class="op">&lt;-</span> <span class="va">ind.ef.g4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">sp_object</span>, file<span class="op">=</span><span class="st">"./Datos/sp_object.Rdata"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">data_risk</span>, file<span class="op">=</span><span class="st">"./Datos/risk_sim.Rdata"</span><span class="op">)</span></span></code></pre></div>
<hr>
<p><br></p>
<div></div>

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;">

</div>
</div>
  <aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/VdaK1NG" class="external-link">Pablo Escobar-Hernández</a>, <a href="https://github.com/FranciscoPalmiPerales" class="external-link">Francisco Palmí-Perales</a>, <a href="https://github.com/antoloqui" class="external-link">Antonio López-Quílez</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></main>
</div>





  </div>
</body>
</html>
